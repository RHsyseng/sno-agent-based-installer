# SNO with OpenShift Agent Based Installer

## Overview

Note: This repo only works for OpenShift 4.12+. For 4.9/4.10 please use this [helper script](https://github.com/borball/sno-manual-helper)

This repo provides set of helper scripts for SNO deployment with [OpenShift Agent Based Installer](https://docs.openshift.com/container-platform/4.12/installing/installing_with_agent_based_installer/preparing-to-install-with-agent-based-installer.html) and install operators and apply tunings which are recommended and required by DU applications.

- sno-iso: Used to generate bootable OCP image based on agent based installer, operators and tunings for [DU applications](https://github.com/openshift-kni/cnf-features-deploy/tree/release-4.12/ztp/gitops-subscriptions/argocd/example/policygentemplates) by default are enabled as day0 operations.
- sno-install: Used to mount the ISO image generated by sno-iso to BMC console as virtual media with Redfish API, and boot the node from the image to trigger the SNO installation. Tested on HPE, ZT and KVM with Sushy tools, other server may/not work, please create issues if not.
- sno-day1: Most of the operators and tunings required by DU applications are enabled as day0, but some of them can only be done as [day1 configurations](templates/openshift/day1).
- sno-ready: Used to validate if the SNO cluster has all DU required tunings.

## Dependencies
Some software and tools are required to be installed before running the scripts:

- nmstatectl: sudo dnf install /usr/bin/nmstatectl -y
- yq: https://github.com/mikefarah/yq#install
- jinja2: pip3 install jinja2-cli, pip3 install jinja2-cli[yaml] 
 
## Configuration

Prepare config.yaml to fit your lab situation, here is an example:

```yaml
cluster:
  domain: outbound.vz.bos2.lab
  name: sno148

host:
  interface: ens1f0
  stack: ipv4
  hostname: sno148.outbound.vz.bos2.lab
  ip: 192.168.58.48
  dns: 192.168.58.15
  gateway: 192.168.58.1
  mac: b4:96:91:b4:9d:f0
  prefix: 25
  machine_network_cidr: 192.168.58.0/25
  vlan:
    enabled: false
    name: ens1f0.58
    id: 58
  disk: /dev/nvme0n1

cpu:
  isolated: 2-31,34-63
  reserved: 0-1,32-33

proxy:
  enabled: false
  http:
  https:
  noproxy:

pull_secret: ./pull-secret.json
ssh_key: /root/.ssh/id_rsa.pub

```
Other samples:

- [IPv4](config.yaml)
- [IPv6 with proxy](config-ipv6.yaml)

By default following will be enabled during day0(installation phase):

  - Workload partitioning
  - SNO boot accelerate
  - Kdump service/config
  - Local Storage Operator
  - PTP Operator
  - SR-IOV Network Operator

You can turn on or turn off the day0 operations in the config file under section day0:

```yaml
day0:
  workload_partition: false  #default true
  kdump: false  #default true
  ptp: false  #default true
  sriov: false #default true
  storage: true #default true
  accelerate: true #default true
  gitops: true #default false
  rhacm: true #default false
  talm: true #default false
```
Get more information from [config usages](samples/usage.md).

In some case you may want to include more customizations for the cluster during day0, you can create folder extra-manifests and put those CRs inside before you run sno-iso.sh, the script will copy and include those inside the ISO image.

## Generate ISO image

You can run sno-iso.sh [config file] to generate a bootable ISO image so that you can boot from BMC console to install SNO. By default stable-4.12 will be downloaded and installed if not specified.

Usage:

```shell
./sno-iso.sh
```
This will take config.yaml as the configuration file.

or:
```
./sno-iso.sh config-ipv6.yaml
```
This will take config-ipv6.yaml as the configuration file.

You can also specify which OCP version you want to install: 

```
./sno-iso.sh config-ipv6.yaml 4.12.8
```

Version can be: stable-4.12, latest-4.12, fast-4.12, 4.12.5, etc. [All versions](https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/).

An example:

```shell
# ./sno-iso.sh config-ipv6.yaml
You are going to download OpenShift installer 4.12.8
% Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
Dload  Upload   Total   Spent    Left  Speed
100  333M  100  333M    0     0  28.3M      0  0:00:11  0:00:11 --:--:-- 32.9M

Enabling day0 configuration...
Workload partitioning:          enabled
SNO boot accelerate:            enabled
kdump service/config:           enabled
Local Storage Operator:         enabled
PTP Operator:                   enabled
SR-IOV Network Operator:        enabled
Red Hat ACM:                    disabled
GitOps Operator:                disabled
TALM Operator:                  disabled

Copy customized CRs from extra-manifests folder if present
total 0

Generating boot image...

INFO The rendezvous host IP (node0 IP) is 2600:52:7:58::48
INFO Extracting base ISO from release payload     
INFO Base ISO obtained from release and cached at /root/.cache/agent/image_cache/coreos-x86_64.iso
INFO Consuming Install Config from target directory 
INFO Consuming Agent Config from target directory 
INFO Consuming Extra Manifests from target directory

------------------------------------------------
kubeconfig: sno148/auth/kubeconfig.
kubeadmin password: sno148/auth/kubeadmin-password.
------------------------------------------------

Next step: Go to your BMC console and boot the node from ISO: sno148/agent.x86_64.iso.
You can also run ./sno-install.sh to boot the node from the image automatically if you have a HTTP server serves the image.
Enjoy!

```

## Boot node from ISO image

Once you generate the ISO image, you can boot the node from the image with your prefered way, OCP will be installed automatically.

A helper script sno-install.sh is available in this repo to boot the node from ISO and trigger the installation automatically, assume you have an HTTP server (http://192.168.58.15/iso in our case) to host the ISO image.


```shell
# ./sno-install.sh 
Usage : ./sno-install.sh bmc_address username_password iso_image node_ip [kvm_uuid]
kvm_uuid is optional, required when deploying SNO on KVM with sushy-tool simulator.
Example : ./sno-install.sh 192.168.13.147 Administrator:dummy http://192.168.58.15/iso/agent-412.iso 192.168.58.47 [11111111-1111-1111-1111-111111111100]

```

Following is an example:
- BMC: 192.168.13.148
- Username and password to access BMC: Administrator:dummy
- ISO image location: http://192.168.58.15/iso/agent-148.iso
- SNO Node IP: 2600:52:7:58::48

To install OCP:

```shell

# ./sno-install.sh 192.168.13.148 Administrator:dummy http://192.168.58.15/iso/agent-148.iso [2600:52:7:58::48]
-------------------------------
Starting SNO deployment...

Power off server.
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   252  100   227  100    25    267     29 --:--:-- --:--:-- --:--:--   296
{"@odata.context":"/redfish/v1/$metadata#Task.Task","@odata.id":"/redfish/v1/TaskService/Tasks/107","@odata.type":"#Task.v1_4_2.Task","Description":"Task for Computer Reset","Id":"107","Name":"Computer Reset","TaskState":"New"}202 https://192.168.13.148/redfish/v1/Systems/Self/Actions/ComputerSystem.Reset
-------------------------------

Insert Virtual Media: http://192.168.58.15/iso/agent-148.iso
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100    51    0     0  100    51      0      2  0:00:25  0:00:20  0:00:05     0
204 https://192.168.13.148/redfish/v1/Managers/Self/VirtualMedia/1/Actions/VirtualMedia.InsertMedia
-------------------------------

Virtual Media Status: 
{
  "@odata.context": "/redfish/v1/$metadata#VirtualMedia.VirtualMedia",
  "@odata.etag": "\"1680358577\"",
  "@odata.id": "/redfish/v1/Managers/Self/VirtualMedia/1",
  "@odata.type": "#VirtualMedia.v1_3_2.VirtualMedia",
  "Actions": {
    "#VirtualMedia.EjectMedia": {
      "target": "/redfish/v1/Managers/Self/VirtualMedia/1/Actions/VirtualMedia.EjectMedia"
    },
    "#VirtualMedia.InsertMedia": {
      "target": "/redfish/v1/Managers/Self/VirtualMedia/1/Actions/VirtualMedia.InsertMedia"
    }
  },
  "ConnectedVia": "URL",
  "Description": "Virtual Removable Media",
  "Id": "1",
  "Image": "http://192.168.58.15/iso/agent-148.iso",
  "ImageName": "agent-148.iso",
  "Inserted": true,
  "MediaStatus": "Mounted",
  "MediaTypes": [
    "CD"
  ],
  "Name": "VirtualMedia",
  "WriteProtected": true
}
-------------------------------

Boot node from Virtual Media Once
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100    82    0     0  100    82      0     27  0:00:03  0:00:03 --:--:--    27
204 https://192.168.13.148/redfish/v1/Systems/Self
-------------------------------

Power on server.
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   246  100   227  100    19    356     29 --:--:-- --:--:-- --:--:--   386
{"@odata.context":"/redfish/v1/$metadata#Task.Task","@odata.id":"/redfish/v1/TaskService/Tasks/108","@odata.type":"#Task.v1_4_2.Task","Description":"Task for Computer Reset","Id":"108","Name":"Computer Reset","TaskState":"New"}202 https://192.168.13.148/redfish/v1/Systems/Self/Actions/ComputerSystem.Reset

-------------------------------
Node is booting from virtual media mounted with http://192.168.58.15/iso/agent-148.iso, check your BMC console to monitor the installation progress.


Node booting.......

Installing in progress...

More logs omitted..

-------------------------------
Installation in progress: completed 10/100
Installation in progress: completed 33/100
Installation in progress: completed 33/100
Installation in progress: completed 45/100
...
Installation in progress: completed 56/100
Installation in progress: completed 68/100
-------------------------------
Node Rebooted...
Installation still in progress, oc command will be available soon, please check the installation progress with oc commands.

```

After couple of mins, you should be able to use oc commands to check the instllation progress:

```shell
# oc get clusterversion
NAME      VERSION   AVAILABLE   PROGRESSING   SINCE   STATUS
version             False       True          24m     Working towards 4.12.8: 535 of 830 done (64% complete)
```

## Day1 operations

Some CRs are not supported in installation phase as day0 operations including PerformanceProfile(4.13+ will support), those can/shall be done as day 1 operations once SNO is deployed.

```shell
# ./sno-day1.sh 
NAME      VERSION   AVAILABLE   PROGRESSING   SINCE   STATUS
version   4.12.8    True        False         167m    Cluster version is 4.12.8

NAME                          STATUS   ROLES                         AGE     VERSION
sno148.outbound.vz.bos2.lab   Ready    control-plane,master,worker   3h14m   v1.25.7+eab9cc9

NAME                                       VERSION   AVAILABLE   PROGRESSING   DEGRADED   SINCE   MESSAGE
authentication                             4.12.8    True        False         False      171m    
baremetal                                  4.12.8    True        False         False      3h3m    
cloud-controller-manager                   4.12.8    True        False         False      3h3m    
cloud-credential                           4.12.8    True        False         False      3h10m   
cluster-autoscaler                         4.12.8    True        False         False      3h3m    
config-operator                            4.12.8    True        False         False      3h11m   
console                                    4.12.8    True        False         False      171m    
control-plane-machine-set                  4.12.8    True        False         False      3h4m    
csi-snapshot-controller                    4.12.8    True        False         False      179m    
dns                                        4.12.8    True        False         False      3h3m    
etcd                                       4.12.8    True        False         False      3h8m    
image-registry                             4.12.8    True        False         False      171m    
ingress                                    4.12.8    True        False         False      3h10m   
insights                                   4.12.8    True        False         False      3h4m    
kube-apiserver                             4.12.8    True        False         False      179m    
kube-controller-manager                    4.12.8    True        False         False      3h2m    
kube-scheduler                             4.12.8    True        False         False      179m    
kube-storage-version-migrator              4.12.8    True        False         False      179m    
machine-api                                4.12.8    True        False         False      3h3m    
machine-approver                           4.12.8    True        False         False      3h4m    
machine-config                             4.12.8    True        False         False      3h10m   
marketplace                                4.12.8    True        False         False      3h10m   
monitoring                                 4.12.8    True        False         False      177m    
network                                    4.12.8    True        False         False      3h12m   
node-tuning                                4.12.8    True        False         False      179m    
openshift-apiserver                        4.12.8    True        False         False      171m    
openshift-controller-manager               4.12.8    True        False         False      179m    
openshift-samples                          4.12.8    True        False         False      179m    
operator-lifecycle-manager                 4.12.8    True        False         False      3h3m    
operator-lifecycle-manager-catalog         4.12.8    True        False         False      3h3m    
operator-lifecycle-manager-packageserver   4.12.8    True        False         False      179m    
service-ca                                 4.12.8    True        False         False      3h11m   
storage                                    4.12.8    True        False         False      3h3m    

NAME                                                      AGE
local-storage-operator.openshift-local-storage            3h3m
ptp-operator.openshift-ptp                                3h3m
sriov-network-operator.openshift-sriov-network-operator   3h3m

NAMESPACE                              NAME                                          DISPLAY                   VERSION               REPLACES   PHASE
openshift-local-storage                local-storage-operator.v4.12.0-202303081116   Local Storage             4.12.0-202303081116              Succeeded
openshift-operator-lifecycle-manager   packageserver                                 Package Server            0.19.0                           Succeeded
openshift-ptp                          ptp-operator.4.12.0-202303151915              PTP Operator              4.12.0-202303151915              Succeeded
openshift-sriov-network-operator       sriov-network-operator.v4.12.0-202303210718   SR-IOV Network Operator   4.12.0-202303210718              Succeeded


------------------------------------------------
Applying day1 operations....

performanceprofile.performance.openshift.io/sno-performance-profile created
tuned.tuned.openshift.io/performance-patch created
configmap/cluster-monitoring-config created
operatorhub.config.openshift.io/cluster patched
console.operator.openshift.io/cluster patched
network.operator.openshift.io/cluster patched

Done.
```

## Validation

After applying all day1 operarions, node may be rebooted once, check if all DU required tunings and operators are in placed:

```shell
# ./sno-ready.sh 
NAME                          STATUS   ROLES                         AGE     VERSION
sno148.outbound.vz.bos2.lab   Ready    control-plane,master,worker   3h34m   v1.25.7+eab9cc9

Checking node:
 [+]Node is ready.

Checking all pods:
 [+]No failing pods.

Checking required machine config:
 [+]MachineConfig container-mount-namespace-and-kubelet-conf-master exits.
 [+]MachineConfig 02-master-workload-partitioning exits.
 [+]MachineConfig 04-accelerated-container-startup-master exits.
 [+]MachineConfig 05-kdump-config-master exits.
 [+]MachineConfig 06-kdump-enable-master exits.
 [+]MachineConfig 99-crio-disable-wipe-master exits.
 [-]MachineConfig disable-chronyd is not existing.

Checking machine config pool:
 [+]mcp master is updated and not degraded.

Checking required performance profile:
 [+]PerformanceProfile sno-performance-profile exits.
 [+]topologyPolicy is single-numa-node
 [+]realTimeKernel is enabled

Checking required tuned:
 [+]Tuned performance-patch exits.

Checking SRIOV operator status:
 [+]sriovnetworknodestate sync status is 'Succeeded'.

Checking PTP operator status:
 [+]Ptp linuxptp-daemon is ready.
No resources found in openshift-ptp namespace.
 [-]PtpConfig not exist.

Checking openshift monitoring.
 [+]Grafana is not enabled.
 [+]AlertManager is not enabled.
 [+]PrometheusK8s retention is not 24h.

Checking openshift console.
 [+]Openshift console is disabled.

Checking network diagnostics.
 [+]Network diagnostics is disabled.

Checking Operator hub.
 [+]Catalog community-operators is disabled.
 [+]Catalog redhat-marketplace is disabled.

Checking /proc/cmdline:
 [+]systemd.cpu_affinity presents: systemd.cpu_affinity=0,1,32,33
 [+]isolcpus presents: isolcpus=managed_irq,2-31,34-63
 [+]Isolated cpu in cmdline: 2-31,34-63 matches with the ones in performance profile: 2-31,34-63
 [+]Reserved cpu in cmdline: 0,1,32,33 matches with the ones in performance profile: 0-1,32-33

Checking RHCOS kernel:
 [+]Node is realtime kernel.

Checking kdump.service:
 [+]kdump is active.
 [+]kdump is enabled.

Checking chronyd.service:
 [-]chronyd is active.
 [-]chronyd is enabled.

Checking crop-wipe.service:
 [+]crio-wipe is inactive.
 [+]crio-wipe is not enabled.

Completed the checking.

```
